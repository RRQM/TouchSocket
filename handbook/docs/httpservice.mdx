---
id: httpservice
title: åˆ›å»ºHttpService
---

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";
import CardLink from "@site/src/components/CardLink.js";
import BilibiliCard from '@site/src/components/BilibiliCard.js';
import { TouchSocketHttpDefinition } from "@site/src/components/Definition.js";
import CustomCodeBlock from './CodeBlocks/CustomCodeBlock';

### å®šä¹‰

<TouchSocketHttpDefinition />


## ä¸€ã€è¯´æ˜

`HttpService`æ˜¯`TouchSocket`æ¡†æ¶ä¸­ç”¨äºæ„å»ºé«˜æ€§èƒ½HTTPæœåŠ¡çš„æ ¸å¿ƒç»„ä»¶ã€‚å®ƒæä¾›äº†ä¸€ä¸ªè½»é‡çº§ã€é«˜æ•ˆçš„WebæœåŠ¡è§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒç°ä»£Webå¼€å‘çš„å„ç§éœ€æ±‚ã€‚æ— è®ºæ˜¯æ„å»º`REST API`ã€`WebæœåŠ¡`è¿˜æ˜¯`æ–‡ä»¶æœåŠ¡å™¨`ï¼Œ`HttpService`éƒ½èƒ½æä¾›å“è¶Šçš„æ€§èƒ½å’Œç®€æ´çš„å¼€å‘ä½“éªŒã€‚

**ç‰¹åˆ«å€¼å¾—æ³¨æ„çš„æ˜¯**ï¼Œ`HttpService`æ‹¥æœ‰ä¸šç•Œé¢†å…ˆçš„æ¡†æ¶å…¼å®¹æ€§ï¼Œä»ç»å…¸çš„`.NET Framework 4.6.2`åˆ°æœ€æ–°çš„`.NET 9.0`å…¨ç³»åˆ—æ”¯æŒï¼Œè®©æ‚¨çš„é¡¹ç›®æ— è®ºæ˜¯å‡çº§æ”¹é€ è¿˜æ˜¯å…¨æ–°å¼€å‘éƒ½èƒ½äº«å—åˆ°ç»Ÿä¸€çš„å¼€å‘ä½“éªŒã€‚

<BilibiliCard title="è½»é‡çº§Webå¼€å‘æ¡†æ¶åºç« " link="https://www.bilibili.com/cheese/play/ep1618488" isPro="true"/>

## äºŒã€æ ¸å¿ƒç‰¹æ€§

`HttpService`å…·å¤‡ä»¥ä¸‹çªå‡ºç‰¹æ€§ï¼š

- **ğŸ¯ å¹¿æ³›æ¡†æ¶æ”¯æŒ** - ä»`.NET Framework 4.6.2`åˆ°`.NET 9.0`å…¨ç‰ˆæœ¬æ”¯æŒï¼Œå…¼å®¹æ€§å“è¶Š
- **ğŸ” å®Œæ•´`HTTPS`æ”¯æŒ** - æ”¯æŒ`SSL/TLS`åŠ å¯†è¿æ¥ï¼Œç¡®ä¿æ•°æ®ä¼ è¾“å®‰å…¨
- **ğŸ“Š å¤šç§æ•°æ®å¤„ç†æ¨¡å¼** - çµæ´»å¤„ç†å„ç§ç±»å‹çš„`HTTP`è¯·æ±‚æ•°æ®
- **ğŸŒ å¤šåœ°å€ç›‘å¬** - å¯åŒæ—¶ç›‘å¬å¤šä¸ª`IP`åœ°å€å’Œç«¯å£ï¼Œå®ç°çµæ´»éƒ¨ç½²
- **âš¡ å“è¶Šæ€§èƒ½è¡¨ç°** - ç»è¿‡ä¼˜åŒ–çš„é«˜æ€§èƒ½`HTTP`å¤„ç†å¼•æ“
- **ğŸ”„ è·¨åŸŸæ”¯æŒ(CORS)** - å†…ç½®è·¨åŸŸèµ„æºå…±äº«æ”¯æŒï¼Œç®€åŒ–å‰åç«¯åˆ†ç¦»å¼€å‘
- **ğŸ“¦ AOTåŸç”Ÿæ”¯æŒ** - æ”¯æŒæå‰ç¼–è¯‘ï¼Œéƒ¨ç½²ä½“ç§¯æ¯”AspNetCoreå°50%ï¼Œå¯åŠ¨æ›´å¿«

<BilibiliCard title="ä½¿ç”¨JMeterå¯¹Httpç»„ä»¶è¿›è¡Œæ€§èƒ½æµ‹è¯•" link="https://www.bilibili.com/cheese/play/ep1618489" isPro="true"/>
<BilibiliCard title="Aotå‘å¸ƒåä¸AspNetCoreè¿›è¡Œå¯¹æ¯”" link="https://www.bilibili.com/cheese/play/ep1618490" isPro="true"/>

## ä¸‰ã€åº”ç”¨åœºæ™¯

`HttpService` é€‚ç”¨äºä»¥ä¸‹å¤šç§åœºæ™¯ï¼š

- **ğŸ”— RESTful APIæœåŠ¡** - æ„å»ºæ ‡å‡†çš„RESTé£æ ¼çš„`Web API`æ¥å£
- **ğŸŒ è·¨å¹³å°WebæœåŠ¡** - æ”¯æŒ`Windows`ã€`Linux`ã€`macOS`ç­‰å¤šå¹³å°éƒ¨ç½²
- **ğŸ—ï¸ é—ç•™ç³»ç»Ÿé›†æˆ** - å®Œç¾æ”¯æŒ`.NET Framework 4.6.2+`ï¼Œå¯æ— ç¼é›†æˆåˆ°ç°æœ‰è€é¡¹ç›®
- **ğŸš€ ç°ä»£åº”ç”¨å¼€å‘** - å…¨é¢æ”¯æŒ`.NET Core/.NET 5-9`ï¼Œäº«å—æœ€æ–°æ¡†æ¶ç‰¹æ€§
- **ğŸ“ æ–‡ä»¶æœåŠ¡å™¨** - é«˜æ•ˆçš„æ–‡ä»¶ä¸Šä¼ ã€ä¸‹è½½å’Œç®¡ç†æœåŠ¡
- **ğŸ”Œ å¾®æœåŠ¡æ¶æ„** - è½»é‡çº§çš„å¾®æœåŠ¡HTTPé€šä¿¡ç»„ä»¶
- **ğŸ–¥ï¸ æ··åˆåº”ç”¨åç«¯** - ä¸ºæ¡Œé¢åº”ç”¨ã€ç§»åŠ¨åº”ç”¨æä¾›HTTPæœåŠ¡æ”¯æŒ
- **ğŸ“¡ IoTè®¾å¤‡é€šä¿¡** - ç‰©è”ç½‘è®¾å¤‡çš„HTTPæ¥å£æœåŠ¡


## å››ã€æ¶æ„è®¾è®¡

`HttpService`é‡‡ç”¨é«˜æ•ˆçš„ä¼šè¯ç®¡ç†æ¶æ„è®¾è®¡ï¼š

### è¿æ¥ç®¡ç†æ¨¡å‹

å½“HTTPå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨å»ºç«‹è¿æ¥æ—¶ï¼Œ`HttpService`ä¼šä¸ºæ¯ä¸ªè¿æ¥åˆ›å»ºä¸€ä¸ªä¸“é—¨çš„`HttpSessionClient`å®ä¾‹ã€‚è¿™ç§è®¾è®¡æ¨¡å¼ç¡®ä¿äº†ï¼š

- **ä¼šè¯éš”ç¦»** - æ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥æ‹¥æœ‰ç‹¬ç«‹çš„å¤„ç†å®ä¾‹
- **å¹¶å‘å®‰å…¨** - å¤šä¸ªå®¢æˆ·ç«¯å¯ä»¥åŒæ—¶è®¿é—®æœåŠ¡å™¨è€Œä¸ç›¸äº’å¹²æ‰°  
- **èµ„æºä¼˜åŒ–** - åˆç†çš„è¿æ¥ç®¡ç†å’Œèµ„æºåˆ†é…

```mermaid
flowchart TD;
    Service[HttpService]-->HttpSessionClient-1[HttpSessionClient-1];
    Service-->HttpSessionClient-2[HttpSessionClient-2];
    Service-->HttpSessionClient-3[HttpSessionClient-3];
    HttpSessionClient-1-->HttpClient-1[HttpClient-1];
    HttpSessionClient-2-->HttpClient-2[HttpClient-2];
    HttpSessionClient-3-->HttpClient-3[HttpClient-3];
   
```

<BilibiliCard title="HttpContextçš„ç”Ÿå‘½å‘¨æœŸ" link="https://www.bilibili.com/cheese/play/ep1688270" isPro="true"/>

## äº”ã€æ’ä»¶æ‰©å±•æœºåˆ¶

`HttpService`æä¾›äº†å¼ºå¤§çš„æ’ä»¶ç³»ç»Ÿï¼Œå…è®¸å¼€å‘è€…é€šè¿‡å®ç°`IHttpPlugin`æ¥å£æˆ–ç»§æ‰¿`PluginBase`åŸºç±»æ¥æ‰©å±•åŠŸèƒ½ã€‚

### æ”¯æŒçš„æ’ä»¶æ¥å£

| æ’ä»¶æ¥å£ | è§¦å‘æ—¶æœº | åŠŸèƒ½è¯´æ˜ |
| --- | --- | --- |
| `IHttpPlugin` | æ¥æ”¶åˆ°HTTPè¯·æ±‚æ—¶ | å¤„ç†æ‰€æœ‰HTTPè¯·æ±‚ï¼Œæ”¯æŒé“¾å¼å¤„ç† |

### æ’ä»¶å®ç°æ–¹å¼

1. **æ¥å£å®ç°** - ç›´æ¥å®ç°`IHttpPlugin`æ¥å£
2. **åŸºç±»ç»§æ‰¿** - ç»§æ‰¿`PluginBase`ç±»å¹¶é‡å†™ç›¸åº”æ–¹æ³•
3. **å§”æ‰˜æ–¹å¼** - é€šè¿‡å§”æ‰˜å‡½æ•°å¿«é€Ÿæ·»åŠ å¤„ç†é€»è¾‘


## å…­ã€å¿«é€Ÿå¼€å§‹

åˆ›å»º`HttpService`çš„è¿‡ç¨‹ç®€å•ç›´è§‚ï¼Œç±»ä¼¼äº`TcpService`çš„é…ç½®æ–¹å¼ã€‚å¹¶ä¸”é€‚åº”[TcpServiceçš„æ‰€æœ‰é…ç½®é¡¹ç›®](./tcpservice.mdx)

ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„åˆ›å»ºç¤ºä¾‹ï¼š

<BilibiliCard title="åˆ›å»ºHttpæœåŠ¡å™¨" link="https://www.bilibili.com/cheese/play/ep1618491" isPro="true"/>

### 6.1 åˆ›å»ºHttpæœåŠ¡å™¨

<CustomCodeBlock region="åˆ›å»ºHttpæœåŠ¡å™¨"/>

:::tip æç¤º

`DefaultHttpServicePlugin`æ’ä»¶å»ºè®®æ·»åŠ åˆ°æ’ä»¶é“¾çš„æœ«å°¾ï¼Œå®ƒè´Ÿè´£ï¼š
- ä¸ºæ‰¾ä¸åˆ°åŒ¹é…è·¯ç”±çš„è¯·æ±‚è¿”å›404çŠ¶æ€
- è‡ªåŠ¨å¤„ç†OPTIONSæ–¹æ³•çš„CORSé¢„æ£€è¯·æ±‚

å¦‚æœä¸ä½¿ç”¨æ­¤æ’ä»¶ï¼Œéœ€è¦è‡ªè¡Œå¤„ç†è¿™äº›é»˜è®¤åœºæ™¯ã€‚

:::  

### 6.2 æ¥æ”¶å¹¶å¤„ç†è¯·æ±‚

åœ¨httpæœåŠ¡å™¨ä¸­ï¼Œæ‰€æœ‰çš„è¯·æ±‚å¤„ç†éƒ½é€šè¿‡æ’ä»¶æ¥å®Œæˆã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„æ’ä»¶ç¤ºä¾‹ï¼š

<CustomCodeBlock region="HttpæœåŠ¡å™¨ä½¿ç”¨æ’ä»¶"/>

## ä¸ƒã€è¯·æ±‚æ•°æ®è·å–

### HttpContextç”Ÿå‘½å‘¨æœŸ

æ¯å½“HTTPå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨å»ºç«‹è¿æ¥æ—¶ï¼Œç³»ç»Ÿä¼šåˆ›å»ºï¼š
- ä¸€ä¸ª`HttpSessionClient`å®ä¾‹ - è´Ÿè´£ç®¡ç†å®¢æˆ·ç«¯è¿æ¥
- ä¸€ä¸ª`HttpContext`å®ä¾‹ - è´Ÿè´£å¤„ç†HTTPè¯·æ±‚/å“åº”ä¸Šä¸‹æ–‡

å¯¹äºåŒä¸€ä¸ªè¿æ¥çš„æ‰€æœ‰HTTPè¯·æ±‚ï¼Œéƒ½ä¼šå¤ç”¨åŒä¸€ä¸ª`HttpContext`å®ä¾‹ï¼Œé€šè¿‡å…¶`Request`å’Œ`Response`å±æ€§å¯ä»¥è®¿é—®è¯·æ±‚æ•°æ®å’Œæ„å»ºå“åº”å†…å®¹ã€‚

```csharp showLineNumbers
var request = e.Context.Request;   //è·å–HTTPè¯·æ±‚å¯¹è±¡
var response = e.Context.Response; //è·å–HTTPå“åº”å¯¹è±¡
```

<BilibiliCard title="Httpæ–¹æ³•è§£æä¸ä½¿ç”¨" link="https://www.bilibili.com/cheese/play/ep1618492" isPro="true"/>

### 7.1 è·å–Queryå‚æ•°

```csharp showLineNumbers
string value = e.Context.Request.Query["key"];
```

<BilibiliCard title="Queryå‚æ•°åŠç”¨æ³•" link="https://www.bilibili.com/cheese/play/ep1618493" isPro="true"/>

### 7.2 è·å–Headerå‚æ•°

```csharp showLineNumbers
string value = e.Context.Request.Headers["key"];
```

äº¦æˆ–è€…

```csharp showLineNumbers
string value = e.Context.Request.Headers[HttpHeaders.Cookie];
```

<BilibiliCard title="Headerå‚æ•°åŠç”¨æ³•" link="https://www.bilibili.com/cheese/play/ep1618495" isPro="true"/>

### 7.3 è·å–Formå‚æ•°

```csharp showLineNumbers
var multifileCollection =await e.Context.Request.GetFormCollectionAsync();
foreach (var item in multifileCollection)
{
    Console.WriteLine($"key={item.Key},value={item.Value}");
}
```

<BilibiliCard title="Formå‚æ•°åŠå°æ–‡ä»¶ä¼ è¾“" link="https://www.bilibili.com/cheese/play/ep1618496" isPro="true"/>
<BilibiliCard title="Form-dataä¸x-www-form-urlencod" link="https://www.bilibili.com/cheese/play/ep1618497" isPro="true"/>

### 7.4 è·å–å­—ç¬¦ä¸²Bodyå†…å®¹

```csharp showLineNumbers
string bodyString = await e.Context.Request.GetBodyAsync();
```

### 7.5 è·å–å°ä½“é‡å­—èŠ‚Bodyå†…å®¹

```csharp showLineNumbers
ReadOnlyMemory<byte> content = await e.Context.Request.GetContentAsync();
```

<BilibiliCard title="æ¥æ”¶å¹¶å¤„ç†Jsonã€Xmlç±»Bodyæ•°æ®" link="https://www.bilibili.com/cheese/play/ep1618500" isPro="true"/>
<BilibiliCard title="æ¥æ”¶Binary(å°æ–‡ä»¶)ç±»Bodyæ•°æ®" link="https://www.bilibili.com/cheese/play/ep1618501" isPro="true"/>

### 7.6 æŒç»­è¯»å–Bodyå†…å®¹

å½“æ•°æ®å¤ªå¤§æ—¶ï¼Œå¯æŒç»­è¯»å–

```csharp showLineNumbers
while (true)
{
    var buffer = new byte[1024 * 64];

    using (var blockResult = await e.Context.Request.ReadAsync())
    {
        //è¿™é‡Œå¯ä»¥ä¸€ç›´å¤„ç†è¯»åˆ°çš„æ•°æ®ã€‚
        blockResult.Memory.CopyTo(buffer);

        if (blockResult.IsCompleted)
        {
            //ç»“æŸ
            break;
        }
    }
}
```

<BilibiliCard title="æ¥æ”¶è¶…å¤§æ–‡ä»¶å­—èŠ‚æµ" link="https://www.bilibili.com/cheese/play/ep1618502" isPro="true"/>

### 7.7 è·å–BodyæŒç»­å†™å…¥Streamä¸­

å½“æ•°æ®å¤ªå¤§æ—¶ï¼Œå¯æŒç»­è¯»å–æ•°æ®ç›´æ¥åˆ°æµå®¹å™¨ä¸­ã€‚

```csharp showLineNumbers
using (var stream = new MemoryStream())
{
    //
    await e.Context.Request.ReadCopyToAsync(stream);
}
```

<BilibiliCard title="æ¥æ”¶è¶…å¤§æ–‡ä»¶æ—¶æ˜¾ç¤ºè¿›åº¦å’Œé€Ÿåº¦(1)" link="https://www.bilibili.com/cheese/play/ep1618503" isPro="true"/>
<BilibiliCard title="æ¥æ”¶è¶…å¤§æ–‡ä»¶æ—¶æ˜¾ç¤ºè¿›åº¦å’Œé€Ÿåº¦(2)" link="https://www.bilibili.com/cheese/play/ep1618504" isPro="true"/>

### 7.8 è·å–Bodyå°æ–‡ä»¶

å½“Bodyå†…å®¹ä¸ºå°æ–‡ä»¶é›†åˆæ—¶ï¼Œå¯ä»¥ä½¿ç”¨è¯¥åŠŸèƒ½ã€‚

```csharp {11,13-19} showLineNumbers
if (e.Context.Request.ContentLength > 1024 * 1024 * 100)//å…¨éƒ¨æ•°æ®ä½“è¶…è¿‡100Mbåˆ™ç›´æ¥æ‹’ç»æ¥æ”¶ã€‚
{
    await e.Context.Response
         .SetStatus(403, "æ•°æ®è¿‡å¤§")
         .AnswerAsync();
    return;
}

//æ­¤æ“ä½œä¼šå…ˆæ¥æ”¶å…¨éƒ¨æ•°æ®ï¼Œç„¶åå†åˆ†å‰²æ•°æ®ã€‚
//æ‰€ä»¥ä¸Šä¼ æ–‡ä»¶ä¸å®œè¿‡å¤§ï¼Œä¸ç„¶ä¼šå†…å­˜æº¢å‡ºã€‚
var multifileCollection =await e.Context.Request.GetFormCollectionAsync();

foreach (var file in multifileCollection.Files)
{
    var stringBuilder = new StringBuilder();
    stringBuilder.Append($"æ–‡ä»¶å={file.FileName}\t");
    stringBuilder.Append($"æ•°æ®é•¿åº¦={file.Length}");
    client.Logger.Info(stringBuilder.ToString());
}

await e.Context.Response
         .SetStatusWithSuccess()
         .FromText("Ok")
         .AnswerAsync();
```
<BilibiliCard title="Formå‚æ•°åŠå°æ–‡ä»¶ä¼ è¾“" link="https://www.bilibili.com/cheese/play/ep1618496" isPro="true"/>
<BilibiliCard title="Form-dataä¸x-www-form-urlencod" link="https://www.bilibili.com/cheese/play/ep1618497" isPro="true"/>

## å…«ã€å“åº”æ„å»ºä¸å‘é€

å½“æ¥æ”¶å¹¶å¤„ç†å®ŒHTTPè¯·æ±‚åï¼Œå¯ä»¥é€šè¿‡`e.Context.Response`å¯¹è±¡æ„å»ºå¹¶å‘é€å“åº”æ•°æ®ã€‚

### å“åº”æ„å»ºæµç¨‹

HTTPå“åº”çš„æ„å»ºéµå¾ªä»¥ä¸‹åŸºæœ¬æµç¨‹ï¼š
1. **è®¾ç½®çŠ¶æ€ç ** - æŒ‡å®šHTTPçŠ¶æ€ç å’ŒçŠ¶æ€æè¿°
2. **æ·»åŠ å“åº”å¤´** - è®¾ç½®å¿…è¦çš„HTTPå¤´éƒ¨ä¿¡æ¯  
3. **è®¾ç½®å“åº”ä½“** - æ·»åŠ å“åº”å†…å®¹æ•°æ®
4. **å‘é€å“åº”** - è°ƒç”¨`AnswerAsync()`å®Œæˆå“åº”å‘é€

### 8.1 è®¾ç½®å“åº”çŠ¶æ€

```csharp showLineNumbers
e.Context.Response.SetStatus(200,"success");
```

### 8.2 è®¾ç½®å“åº”Header

```csharp showLineNumbers
e.Context.Response.AddHeader("key","value");
```

æˆ–è€…

```csharp showLineNumbers
e.Context.Response.AddHeader(HttpHeaders.Origin, "*");
```

### 8.3 è®¾ç½®å“åº”å†…å®¹

```csharp showLineNumbers
e.Context.Response.SetContent("hello");
```

æˆ–è€…ç›´æ¥è¿”å›`Json`ã€`Xml`ã€`Text`ç­‰å†…å®¹ã€‚ä½¿ç”¨æ­¤å¿«æ·æ–¹å¼ï¼Œä¼šåŒæ—¶æ·»åŠ å¯¹åº”çš„`ContentType`Headerã€‚

```csharp showLineNumbers
e.Context.Response.FromJson("{}");
```

<BilibiliCard title="ä»Jsonæ ¼å¼è¿›è¡Œå“åº”" link="https://www.bilibili.com/cheese/play/ep1618507" isPro="true"/>

### 8.4 å¼€å§‹å“åº”å†…å®¹

å½“é€šè¿‡ä¸Šè¿°æ­¥éª¤ï¼Œå®Œæˆäº†å“åº”ä½“çš„æ„å»ºåï¼Œå³å¯ä½¿ç”¨`AnswerAsync`ç›´æ¥è¿›è¡Œå“åº”ã€‚

ä¾‹å¦‚ï¼šå“åº”ä¸€ä¸ª`hello`æ–‡æœ¬å†…å®¹ï¼Œä»£ç å¤§è‡´å¦‚ä¸‹

```csharp showLineNumbers
await e.Context.Response
      .SetStatus(200, "success")
      .AddHeader("key", "value")//å¦‚éœ€è¦
      .FromText("hello")
      .AnswerAsync();
```

<BilibiliCard title="ä»Binaryè¿›è¡Œå“åº”" link="https://www.bilibili.com/cheese/play/ep1618509" isPro="true"/>

### 8.5 æ’ä»¶å“åº”Getè¯·æ±‚

```csharp showLineNumbers
public class MyHttpPlug1 : PluginBase, IHttpPlugin
{
    public async Task OnHttpRequest(IHttpSessionClient client, HttpContextEventArgs e)
    {
        var request = e.Context.Request;//httpè¯·æ±‚ä½“
        var response = e.Context.Response;//httpå“åº”ä½“

        if (request.IsGet()&&request.UrlEquals("/success"))
        {
            //ç›´æ¥å“åº”æ–‡å­—
           await response
                .SetStatus(200, "success")
                .FromText("Success")
                .AnswerAsync();//ç›´æ¥å›åº”
            Console.WriteLine("å¤„ç†/success");
            return;
        }

        //æ— æ³•å¤„ç†ï¼Œè°ƒç”¨ä¸‹ä¸€ä¸ªæ’ä»¶
        await e.InvokeNext();
    }
}
```

### 8.6 å“åº”æ–‡ä»¶è¯·æ±‚

```csharp showLineNumbers
public class MyHttpPlug2 : PluginBase, IHttpPlugin
{
    public async Task OnHttpRequest(IHttpSessionClient client, HttpContextEventArgs e)
    {
        var request = e.Context.Request;//httpè¯·æ±‚ä½“
        var response = e.Context.Response;//httpå“åº”ä½“
        if (request.IsGet() && request.UrlEquals("/file"))
        {
            try
            {
                //ç›´æ¥å›åº”æ–‡ä»¶ã€‚

                var fileInfo = new FileInfo(@"D:\System\Windows.iso");
                var fileName = fileInfo.Name;//å¯ä»¥é‡æ–°åˆ¶å®šæ–‡ä»¶åç§°ï¼Œå±Šæ—¶ï¼Œheaderä¸­ä¼šæ·»åŠ Content-Dispositionå†…å®¹
                var maxSpeed = 1024 * 1024;//æœ€å¤§ä¼ è¾“é€Ÿåº¦
                var bufferLength = 1024 * 64;//ä¸€èˆ¬è¯¥å€¼è¶Šå¤§ï¼Œæ•ˆç‡è¶Šé«˜ï¼Œä½†åŒæ—¶å†…å­˜å ç”¨ä¹Ÿæ›´å¤§
                var autoGzip = true;//è‡ªåŠ¨åˆ¤æ–­æ˜¯å¦åº”ç”¨gzipå‹ç¼©ã€‚

                await response
                    .SetStatusWithSuccess()//å¿…é¡»è¦æœ‰çŠ¶æ€
                    .FromFileAsync(fileInfo, e.Context.Request, fileName, maxSpeed, bufferLength, autoGzip);

                //æˆ–è€…ç›´æ¥ä½¿ç”¨HttpContext
                //await e.Context.FromFileAsync(fileInfo, fileName, maxSpeed, bufferLength, autoGzip);
            }
            catch (Exception ex)
            {
                await response.SetStatus(403, "error")
                      .FromText(ex.Message)
                      .AnswerAsync();
            }

            return;
        }
        await e.InvokeNext();
    }
}
```

:::caution æ³¨æ„

å½“å“åº”çš„æ–‡ä»¶ï¼Œå¸Œæœ›æµè§ˆå™¨ç›´æ¥æ˜¾ç¤ºæ—¶ï¼ˆä¾‹å¦‚ï¼šhtmlï¼Œjsï¼Œcssï¼‰ï¼Œä¸åº”è¯¥æŒ‡å®šæ–‡ä»¶åï¼Œä¸ç„¶æµè§ˆå™¨ä¼šè°ƒç”¨ä¸‹è½½ä¿å­˜æ“ä½œï¼Œè€Œéç›´æ¥æ˜¾ç¤ºã€‚

:::  

:::tip æç¤º

åœ¨å“åº”æ–‡ä»¶æ—¶ï¼Œä¼ å…¥è¯·æ±‚çš„`request`ï¼Œä¸»è¦æ˜¯å½“è¯·æ±‚åŒ…å«æ–­ç‚¹ç»­ä¼ æ—¶ï¼Œèƒ½æˆåŠŸç»­ä¼ ã€‚æ‰€ä»¥ï¼Œåº”å½“åº”å¯èƒ½çš„æ»¡è¶³è¯¥åŠŸèƒ½ã€‚

:::  

:::tip æç¤º

è¯¥æ“ä½œæ”¯æŒå¤§å‹æ–‡ä»¶ï¼Œä¹Ÿæ”¯æŒæ–­ç‚¹ç»­ä¼ ã€æ”¯æŒè¿…é›·åŠ é€Ÿç­‰ã€‚

:::  

<BilibiliCard title="å“åº”å°æ–‡ä»¶" link="https://www.bilibili.com/cheese/play/ep1618510" isPro="true"/>
<BilibiliCard title="å“åº”è¶…å¤§æ–‡ä»¶" link="https://www.bilibili.com/cheese/play/ep1618511" isPro="true"/>
<BilibiliCard title="å“åº”è¶…å¤§æ–‡ä»¶å¹¶æ˜¾ç¤ºè¿›åº¦å’Œé€Ÿåº¦" link="https://www.bilibili.com/cheese/play/ep1618512" isPro="true"/>


### 8.7 å“åº”é¡µé¢è¯·æ±‚

```csharp showLineNumbers
public class MyHttpPlug3 : PluginBase, IHttpPlugin
{
    public async Task OnHttpRequest(IHttpSessionClient client, HttpContextEventArgs e)
    {
        var request = e.Context.Request;//httpè¯·æ±‚ä½“
        var response = e.Context.Response;//httpå“åº”ä½“
        if (request.IsGet() && request.UrlEquals("/html"))
        {
            //æ„å»ºhtml
            var sb = new StringBuilder();
            sb.Append("<!DOCTYPE html>");
            sb.Append("<html lang=\"zh\">");
            sb.Append("<head>");
            sb.Append("    <meta charset=\"UTF-8\">");
            sb.Append("    <title>TouchSocketç»šä¸½å±•ç¤º</title>");
            sb.Append("    <style>");
            sb.Append("        body {");
            sb.Append("            font-family: Arial, sans-serif;");
            sb.Append("            background-color: #f0f0f0;");
            sb.Append("            display: flex;");
            sb.Append("            justify-content: center;");
            sb.Append("            align-items: center;");
            sb.Append("            height: 100vh;");
            sb.Append("            margin: 0;");
            sb.Append("            padding: 0;");
            sb.Append("            color: transparent;");
            sb.Append("        }");
            sb.Append("        h1 {");
            sb.Append("            font-size: 48px;");
            sb.Append("            letter-spacing: 2px;");
            sb.Append("            background-image: linear-gradient(to right, #ff8a00, #ffcd38);");
            sb.Append("            -webkit-background-clip: text;");
            sb.Append("            background-clip: text;");
            sb.Append("            font-weight: bold;");
            sb.Append("        }");
            sb.Append("    </style>");
            sb.Append("</head>");
            sb.Append("<body>");
            sb.Append("    <h1>TouchSocket</h1>");
            sb.Append("</body>");
            sb.Append("</html>");

            //å›åº”html
            await response
                 .SetStatusWithSuccess()//å¿…é¡»è¦æœ‰çŠ¶æ€
                 .SetContentTypeByExtension(".html")
                 .SetContent(sb.ToString())
                 .AnswerAsync();
            return;
        }

        await e.InvokeNext();
    }
}
```

<BilibiliCard title="ä»Xmlã€Htmlè¿›è¡Œå“åº”" link="https://www.bilibili.com/cheese/play/ep1618508" isPro="true"/>

## ä¹ã€è¿›é˜¶å“åº”æ“ä½œ

### 9.1 å“åº”æœ‰é•¿åº¦å¤§æ•°æ®

å½“å“åº”çš„æ•°æ®ï¼Œåœ¨å“åº”æ—¶ï¼Œå·²çŸ¥æ•°æ®é•¿åº¦çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨æ­¤æ–¹æ³•ã€‚

```csharp showLineNumbers
var request = e.Context.Request;//httpè¯·æ±‚ä½“
var response = e.Context.Response;//httpå“åº”ä½“

//å…ˆè®¾ç½®éœ€è¦å“åº”çš„åœ°æ–¹
response.SetStatus(200, "success");
//ç„¶åè®¾ç½®æ•°æ®æ€»é•¿åº¦
response.ContentLength = 1024 * 1024;

for (int i = 0; i < 1024; i++)
{
    //å°†æ•°æ®æŒç»­å†™å…¥
    await response.WriteAsync(new byte[1024]);
}
```

### 9.2 å“åº”ä¸çŸ¥é•¿åº¦æ•°æ®ï¼ˆChunkæ¨¡å¼ï¼‰

å½“å“åº”çš„æ•°æ®ï¼Œåœ¨å“åº”æ—¶ï¼Œä¸çŸ¥æ•°æ®é•¿åº¦çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨æ­¤æ–¹æ³•ã€‚

```csharp showLineNumbers
var request = e.Context.Request;//httpè¯·æ±‚ä½“
var response = e.Context.Response;//httpå“åº”ä½“

//å…ˆè®¾ç½®éœ€è¦å“åº”çš„åœ°æ–¹
response.SetStatus(200, "success");
//è®¾ç½®ä½¿ç”¨Chunkæ¨¡å¼
response.IsChunk = true;

for (int i = 0; i < 1024; i++)
{
    //å°†æ•°æ®æŒç»­å†™å…¥
    await response.WriteAsync(new byte[1024]);
}

//åœ¨æ­£å¼æ•°æ®ä¼ è¾“å®Œæˆåï¼Œè°ƒç”¨æ­¤æ–¹æ³•ï¼Œå®¢æˆ·ç«¯æ‰çŸ¥é“æ•°æ®ç»“æŸäº†
await response.CompleteChunkAsync();
```

<BilibiliCard title="ä½¿ç”¨Chunkç¼–ç ä¼ è¾“ä¸å®šé•¿æ•°æ®" link="https://www.bilibili.com/cheese/play/ep1618513" isPro="true"/>


## ä¹ã€HTTPSå®‰å…¨æœåŠ¡

### å¯ç”¨SSL/TLSåŠ å¯†

HttpServiceæ”¯æŒå®Œæ•´çš„HTTPSåŠŸèƒ½ï¼Œåªéœ€åœ¨é…ç½®ä¸­æ·»åŠ SSLé€‰é¡¹å³å¯ã€‚HTTPSæœåŠ¡å™¨çš„é…ç½®ä¸HTTPæœåŠ¡å™¨åŸºæœ¬ç›¸åŒï¼Œä»…éœ€å¢åŠ SSLè¯ä¹¦é…ç½®ã€‚

```csharp showLineNumbers
var service = new HttpService();
await service.SetupAsync(new TouchSocketConfig()
     .SetListenIPHosts(443) //HTTPSé»˜è®¤ç«¯å£ä¸º443
     .SetServiceSslOption(new ServiceSslOption() 
     { 
         Certificate = new X509Certificate2("Socket.pfx", "Socket"), //SSLè¯ä¹¦
         SslProtocols = SslProtocols.Tls12 //TLSåè®®ç‰ˆæœ¬
     })
     // ...å…¶ä»–é…ç½®
);
```

### SSLé…ç½®å‚æ•°

æœ‰å…³SSLè¯ä¹¦çš„è¯¦ç»†é…ç½®æ–¹æ³•å’Œå‚æ•°è¯´æ˜ï¼Œè¯·å‚è€ƒï¼š[TcpService SSLé…ç½®](./tcpservice.mdx#sslé…ç½®)

### æ³¨æ„äº‹é¡¹

- **è¯ä¹¦æ ¼å¼** - æ”¯æŒ.pfxã€.crtç­‰æ ‡å‡†è¯ä¹¦æ ¼å¼
- **ç«¯å£é€‰æ‹©** - HTTPSæœåŠ¡é€šå¸¸ä½¿ç”¨443ç«¯å£
- **æ··åˆéƒ¨ç½²** - å¯ä»¥åŒæ—¶è¿è¡ŒHTTP(80)å’ŒHTTPS(443)æœåŠ¡

## åã€ç¤ºä¾‹é¡¹ç›®

ä»¥ä¸‹æ˜¯å®Œæ•´çš„HttpServiceä½¿ç”¨ç¤ºä¾‹ï¼Œå¯ä»¥å¸®åŠ©æ‚¨å¿«é€Ÿä¸Šæ‰‹ï¼š

<CardLink link="examples/Http/HttpServiceConsoleApp"/>
<CardLink link="examples/Http/HttpServiceForCorsConsoleApp"/>