---
id: natservice
title: Tcp端口转发
---
import Tag from "@site/src/components/Tag.js";
import { TouchSocketDefinition } from "@site/src/components/Definition.js";
import CardLink from "@site/src/components/CardLink.js";
import CustomCodeBlock from './CodeBlocks/CustomCodeBlock';


<TouchSocketDefinition />


## 一、说明

**NatService**是具有转发功能的TCP服务器。他的职能是将收到的TCP数据转发到多个目标服务器。也能将多个目标服务器的数据转发到连接客户端。

## 二、常见使用场景

- **调试场景**在生产环境中，想要调试客户端，要么中断服务器，要么就将实际数据转发到Nat，然后在不影响实际场景的情况下进行调试。
- **内网穿透场景**一般tcp都会使用转发式的内网穿透。

要使用`NatService`进行网络地址转换（NAT），您需要遵循以下步骤来设置和运行服务。此示例是基于C#语言，并使用了TouchSocket库来简化网络编程。


## 三、创建服务

### 3.1 创建服务类

创建一个继承自`NatService`的类，并重写必要的方法。在这个例子中，我们创建了一个名为`MyNatService`的类。

<CustomCodeBlock region="NatService创建服务类"/>

### 3.2 创建会话客户端类

创建一个继承自`NatSessionClient`的类，并根据需要重写其中的方法。在这个例子中，我们创建了一个名为`MyNatSessionClient`的类。

<CustomCodeBlock region="NatService创建会话客户端类"/>

## 四、使用

在主函数中初始化服务并开始监听指定端口。这里我们监听的是7788端口，并且设置了日志记录。

<CustomCodeBlock region="NatService创建并启动服务"/>

:::tip 提示

`NatService`支持客户端适配器和`Ssl`。也支持**IRequestInfo转发**和**转发Ssl**。

:::  

## 五、实现一转多

`NatService`支持将客户端数据转发到多个目标服务器。实现方法也比较简单，只需要使用`NatSessionClient`直接进行添加目标客户端即可。

<CustomCodeBlock region="NatService实现一转多"/>

## 六、实现多转一

`NatService`支持将多个客户端数据转发到单个目标服务器。主要实现方式如下：

首先，需要独立初始化目标客户端，然后自行管理其创建和释放。

<CustomCodeBlock region="NatService实现多转一目标客户端管理"/>

然后在`NatSessionClient`中再添加。

<CustomCodeBlock region="NatService实现多转一会话客户端"/>

:::tip 提示

使用静态类管理目标客户端，仅仅是演示目的。在实际使用时，可以考虑使用容器，更加方便地管理。

:::  

## 七、实现多转多

`NatService`支持将多个客户端数据转发到多个目标服务器。实现方法与实现多对一转发类似，只需要使用`NatSessionClient`将多个固定的目标客户端直接进行添加即可。

## 八、示例Demo

<CardLink link="examples\NatService\NatServiceConsoleApp" isPro="true"/>