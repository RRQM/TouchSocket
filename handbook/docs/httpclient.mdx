---
id: httpclient
title: 创建HttpClient
---

import Tag from "@site/src/components/Tag.js";
import CardLink from "@site/src/components/CardLink.js";
import BilibiliCard from '@site/src/components/BilibiliCard.js';
import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";
import { TouchSocketHttpDefinition } from "@site/src/components/Definition.js";
import CustomCodeBlock from './CodeBlocks/CustomCodeBlock';

### 定义

<TouchSocketHttpDefinition />


## 一、说明

`HttpClient`是Http系客户端类，他是基于单个TCP连接的Http客户端。与.NET框架中的HttpClient不同，TouchSocket的HttpClient具有明显的连接、断开连接等动作，且能够复用TCP连接来处理多个Http请求。

## 二、特点

- 简单易用。
- 基于单个TCP连接，支持连接复用。
- 支持Http/Https协议。
- 支持自定义证书验证。
- 内存池支持，高性能处理。
- 支持流式上传和下载。
- 支持SSE(Server-Sent Events)。
- 基于委托、插件驱动，支持AOP扩展。

## 三、产品应用场景

- HTTP API调用：RESTful API客户端实现。
- 文件上传下载：大文件流式传输。
- 实时通信：SSE推送消息接收。
- 微服务通信：服务间HTTP通信。
- 爬虫应用：网页数据抓取。
- HTTPS安全通信：SSL/TLS加密传输。

## 四、可配置项

`HttpClient`继承自`TcpClient`，所以支持所有[TcpClient](./tcpclient.mdx)的所有配置项。

Http基本没有专用配置，但是下面依然会介绍一些在使用Http时的常用相关配置。

### 4.1 目标服务器地址

`HttpClient`必须指定远程服务器地址，支持HTTP和HTTPS协议。支持类型：

1. 使用HTTP协议，传入形如：`http://127.0.0.1:7219`的字符串即可。
2. 使用HTTPS协议，传入形如：`https://127.0.0.1:7219`的字符串即可。
3. 使用域名，必须包含协议类型，形如：`https://api.example.com`或者`http://api.example.com:8080`

<CustomCodeBlock region="Http设置远程服务器地址"/>

### 4.2 SSL/TLS配置

当使用HTTPS协议时，`HttpClient`支持SSL/TLS加密连接。可以通过`SetClientSslOption`方法进行配置。

不过一般来说，如果服务器使用受信任的证书，可以直接使用`https://`协议头连接服务器即可。

例如：

<CustomCodeBlock region="Http简单设置Ssl远程服务器地址"/>

如果是自定义证书，则需要手动加载证书，详情见[创建Ssl的TcpClient配置](./tcpclient.mdx)。

## 五、支持插件接口

支持**ITcpPlugin**所有接口，无特殊接口。

## 六、创建HttpClient

<BilibiliCard title="创建HttpClient并完成请求" link="https://www.bilibili.com/cheese/play/ep1688271" isPro="true"/>
<BilibiliCard title="创建Https客户端" link="https://www.bilibili.com/cheese/play/ep1688272" isPro="true"/>

### 6.1 简单创建HttpClient

<CustomCodeBlock region="简单创建HttpClient"/>


### 6.2 常规配置创建Http客户端

<CustomCodeBlock region="常规配置创建Http客户端"/>

:::info 备注

实际上直接使用`ConnectAsync("https://localhost:7219")`的方式是合并了`SetupAsync`与`ConnectAsync`。所以当需要额外配置时，应当遵循所有配置都在`TouchSocketConfig`的约定。这样代码也比较简单明了。

:::  

## 七、发送HTTP请求

因为`HttpClient`是面向连接的，所以在发送请求时，请求URL只需要填写主机地址之后的部分（即路由部分）。

### 7.1 获取字符串响应

<CustomCodeBlock region="Http通过Get获取字符串"/>

### 7.2 获取字节数组响应

<CustomCodeBlock region="Http客户端获取字节数组响应"/>

### 7.3 获取流数据响应（下载文件）

<CustomCodeBlock region="Http客户端获取流数据响应"/>

### 7.4 自定义请求构建

#### 7.4.1 构建基础自定义请求

<BilibiliCard title="自定义Query和Header参数" link="https://www.bilibili.com/cheese/play/ep1688274" isPro="true"/>

<CustomCodeBlock region="Http客户端构建基础自定义请求"/>

#### 7.4.2 构建自定义请求，持续读取大数据

<BilibiliCard title="使用SSE实现类似AI问答效果" link="https://www.bilibili.com/cheese/play/ep1688275" isPro="true"/>

<CustomCodeBlock region="Http客户端构建自定义请求并持续读取"/>

### 7.5 Post发送JSON数据

<CustomCodeBlock region="Http通过Post发送Json数据"/>

### 7.6 流式上传数据（文件上传）

<CustomCodeBlock region="Http客户端流式上传文件"/>

:::tip 提示

在构建自定义请求时，如果使用`AsGet`、`AsPost`等方法可以直接设置当前请求为`Get`、`Post`等。如果没有扩展方法可以使用时，可以使用`AsMethod`来实现，例如：`AsMethod("PUT")`、`AsMethod("DELETE")`等。

:::  

## 八、最佳实践和注意事项

### 8.1 连接管理

:::tip 提示

1. **连接复用**：TouchSocket的HttpClient是基于单个TCP连接的，可以复用连接发送多个HTTP请求，提高效率。
2. **及时释放**：使用完毕后应及时调用`Dispose()`方法释放资源。
3. **连接池化**：对于大量HTTP请求场景，建议实现连接池来管理HttpClient实例。

:::

### 8.3 性能优化

:::caution 注意

1. **内存管理**：对于大文件传输，使用流式处理避免占用过多内存。
2. **超时设置**：根据实际业务场景合理设置超时时间。
3. **并发控制**：避免单个HttpClient实例并发发送请求，如需并发建议使用多个实例。

:::

## 九、示例Demo

<CardLink link="examples/Http/HttpClientConsoleApp"/>