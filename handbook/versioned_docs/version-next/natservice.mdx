---
id: natservice
title: Tcp端口转发
---
import Tag from "@site/src/components/Tag.js";

### 定义

命名空间：TouchSocket.Sockets <br/>
程序集：[TouchSocket.dll](https://www.nuget.org/packages/TouchSocket)

## 一、说明

**NatService**是具有转发功能的TCP服务器。他的职能是将收到的TCP数据转发到多个目标服务器。也能将多个目标服务器的数据转发到连接客户端。

## 二、常见使用场景

- **调试场景**在生产环境中，想要调试客户端，要么中断服务器，要么就将实际数据转发到Nat，然后在不影响实际场景的情况下进行调试。
- **内网穿透场景**一般tcp都会使用转发式的内网穿透。

要使用`NatService`进行网络地址转换（NAT），您需要遵循以下步骤来设置和运行服务。此示例是基于C#语言，并使用了TouchSocket库来简化网络编程。


## 三、创建服务

### 3.1 创建服务类

创建一个继承自`NatService`的类，并重写必要的方法。在这个例子中，我们创建了一个名为`MyNatService`的类。

```csharp showLineNumbers
internal class MyNatService : NatService<MyNatSessionClient>
{
    protected override MyNatSessionClient NewClient()
    {
        return new MyNatSessionClient();
    }
}
```

### 3.2 创建会话客户端类

创建一个继承自`NatSessionClient`的类，并根据需要重写其中的方法。在这个例子中，我们创建了一个名为`MyNatSessionClient`的类。

```csharp showLineNumbers
class MyNatSessionClient : NatSessionClient
{
    protected override async Task OnNatConnected(ConnectedEventArgs e)
    {
        try
        {
            await this.AddTargetClientAsync(config =>
            {
                config.SetRemoteIPHost("127.0.0.1:7789");
            });
        }
        catch (Exception ex)
        {
            this.Logger.Exception(ex);
        }
    }

    protected override async Task OnTargetClientClosed(ITcpClient tcpClient, ClosedEventArgs e)
    {
        this.RemoveTargetClient(tcpClient);
        await EasyTask.CompletedTask;
    }
}
```

## 四、使用

在主函数中初始化服务并开始监听指定端口。这里我们监听的是7788端口，并且设置了日志记录。

```csharp showLineNumbers
private static async Task Main(string[] args)
{
    var service = new MyNatService();
    await service.SetupAsync(new TouchSocketConfig()
         .SetListenIPHosts(7788)
         .ConfigureContainer(a =>
         {
             a.AddLogger(logger =>
             {
                 logger.AddConsoleLogger();
                 logger.AddFileLogger();
             });
         }));

    await service.StartAsync();

    service.Logger.Info("转发服务器已启动。已将7788端口转发到127.0.0.1:7789地址");

    while (true)
    {
        Console.ReadKey();
    }
}
```

:::tip 提示

`NatService`支持客户端适配器和`Ssl`。也支持**IRequestInfo转发**和**转发Ssl**。

:::  

